```mermaid
graph TD
    subgraph Mamba Block
        direction LR
        
        %% --- Step 1: Input Expansion & Gating ---
        Input_x[Input x] --> Linear_Expand;
        Linear_Expand[Linear Expansion] -- Split --> Stream_z[z (Data Stream)];
        Linear_Expand -- Split --> Stream_gate[gate_x (Gate Stream)];
        
        %% --- Step 2: SSM Core Engine ---
        subgraph SSM Core Engine
            direction TB
            
            % Defining nodes inside the subgraph
            Node_z_input[Input z];
            Dynamic_Controller[Dynamic Controller (Linears)];
            Param_Delta[Δ];
            Param_B[B];
            Param_C[C];
            State_Loop(Recurrent State S);
            Output_y[y (Engine Output)];

            % Defining connections inside the subgraph
            Node_z_input --> Dynamic_Controller;
            Dynamic_Controller --> Param_Delta;
            Dynamic_Controller --> Param_B;
            Dynamic_Controller --> Param_C;
            
            State_Loop -- A (State Evolution) --> State_Loop;
            Node_z_input -- B (Input Injection) --> State_Loop;
            Param_B --> State_Loop;
            
            State_Loop -- C (Output Projection) --> Output_y;
            Param_C --> Output_y;
        end
        
        %% --- Connecting the main stream to the subgraph ---
        Stream_z --> Node_z_input;
        
        %% --- Step 3: Final Gating & Output ---
        Stream_gate --> SiLU[SiLU Activation];
        Output_y --> Multiply[⊗ Element-wise Multiply];
        SiLU --> Multiply;
        
        Multiply --> Linear_Compress[Linear Compression];
        Linear_Compress --> Final_Output[Final Output];
    end

    %% --- Styling ---
    style Mamba Block fill:#f9f,stroke:#333,stroke-width:2px
    style SSM Core Engine fill:#bdf,stroke:#333,stroke-width:2px
```